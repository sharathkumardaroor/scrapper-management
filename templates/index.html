<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scraper Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body class="no-overflow">
  <div class="dashboard-grid">
    <header class="dashboard-header">
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="h3 mb-0">ðŸ“Š Scraper Dashboard</h1>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
            <i class="bi bi-plus-lg"></i> Add URLs
          </button>
        </div>
      </div>
    </header>

    <div class="container-fluid content-area">
      <!-- Stats Row -->
      <div class="stats-row row g-4 mb-4">
        <div class="col-md-3">
          <div class="stat-card">
            <div class="text-secondary mb-1">Total Tasks</div>
            <div class="h3" id="totalTasks">0</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="text-secondary mb-1">Completed</div>
            <div class="h3 text-success" id="completedTasks">0</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="text-secondary mb-1">Running</div>
            <div class="h3 text-warning" id="runningTasks">0</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card">
            <div class="text-secondary mb-1">Failed</div>
            <div class="h3 text-danger" id="failedTasks">0</div>
          </div>
        </div>
      </div>

      <!-- Nav Tabs -->
      <ul class="nav nav-tabs mb-4" id="tabMenu" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button">
            <i class="bi bi-list-task"></i> Recent Tasks
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button">
            <i class="bi bi-database"></i> Scraped Data
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content full-height">
        <!-- Tasks Tab -->
        <div class="tab-pane fade show active full-height" id="tasks">
          <div class="card border-0 shadow full-height">
            <div class="card-header bg-white">
              <h5 class="mb-0">Active Tasks</h5>
            </div>
            <div class="card-body p-0">
              <div class="list-group list-group-flush" id="taskList"></div>
            </div>
          </div>
        </div>

        <!-- Scraped Data Tab -->
        <div class="tab-pane fade full-height" id="data">
          <div class="row full-height">
            <div class="col-md-4 full-height">
              <div class="card border-0 shadow full-height">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Tasks with Data</h5>
                </div>
                <div class="card-body p-0">
                  <div class="list-group list-group-flush" id="scrapedDataList"></div>
                </div>
              </div>
            </div>
            <div class="col-md-8 full-height">
              <div class="card border-0 shadow full-height">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Raw Content</h5>
                </div>
                <div class="card-body">
                  <pre id="rawHtmlPre">Select a task to view scraped content</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add URLs to Scrape</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" action="/create-tasks" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Enter URLs (one per line)</label>
              <textarea name="bulk_urls" class="form-control" rows="4" 
                        placeholder="https://example.com\nhttps://example.org"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Or upload file</label>
              <input type="file" name="bulk_file" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Start Scraping</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let selectedTaskId = null;

    async function updateDashboard() {
      try {
        const response = await fetch("/api/tasks");
        const tasks = await response.json();

        // Update stats
        document.getElementById('totalTasks').textContent = tasks.length;
        document.getElementById('completedTasks').textContent = tasks.filter(t => t.status === 'completed').length;
        document.getElementById('runningTasks').textContent = tasks.filter(t => t.status === 'running').length;
        document.getElementById('failedTasks').textContent = tasks.filter(t => t.status === 'failed').length;

        // Update task list
        const taskList = document.getElementById('taskList');
        taskList.innerHTML = tasks.map(task => `
          <div class="list-group-item task-card ${task.status}">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="d-flex align-items-center gap-2 mb-1">
                  <span class="status-badge bg-${task.status}">${task.status}</span>
                  <small class="text-muted">${new Date(task.created_at).toLocaleString()}</small>
                </div>
                <div class="text-break">${task.url}</div>
              </div>
              ${task.status_code ? `<span class="badge bg-secondary">${task.status_code}</span>` : ''}
            </div>
          </div>
        `).join('');

        // Update Scraped Data List
        const scrapedList = document.getElementById('scrapedDataList');
        const scrapedTasks = tasks.filter(t => t.raw_html && t.raw_html.trim() !== '');
        scrapedList.innerHTML = scrapedTasks.map(task => `
          <div class="list-group-item ${task.id === selectedTaskId ? 'active' : ''}" 
               data-task-id="${task.id}"
               onclick="showScrapedContent('${encodeURIComponent(task.raw_html).replace(/'/g, "\\'")}', ${task.id})">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <span class="badge bg-primary me-2">#${task.id}</span>
                ${task.url}
              </div>
              <small class="text-muted">${task.status}</small>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error("Dashboard update error:", error);
      }
    }

    function showScrapedContent(content, taskId) {
      try {
        // Decode content safely
        const decodedContent = decodeURIComponent(content.replace(/\+/g, ' '));
        
        // Update displayed content
        document.getElementById('rawHtmlPre').textContent = decodedContent;
        
        // Update active state
        document.querySelectorAll('#scrapedDataList .list-group-item').forEach(item => {
            item.classList.remove('active');
            const itemTaskId = parseInt(item.getAttribute('data-task-id'));
            if (itemTaskId === taskId) {
                item.classList.add('active');
            }
        });
        
        // Update the selected task ID
        selectedTaskId = taskId;
      } catch (error) {
        console.error('Error showing content:', error);
      }
    }

    // Update every 3 seconds
    setInterval(updateDashboard, 3000);
    updateDashboard();
  </script>
</body>
</html>